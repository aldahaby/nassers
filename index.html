<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login to Gold Prices</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    /* [Styles left exactly the same as you wrote them] */
    /* ... (All your existing CSS untouched) ... */
  </style>
</head>
<body>
  <div id="login-container">
    <div id="login-box">
      <h2>Enter Username and Password</h2>
      <input type="text" id="username" placeholder="Username" />
      <input type="password" id="password" placeholder="Password" />
      <p id="login-error">Incorrect username or password.</p>
      <button onclick="login()">Log in</button>
    </div>
  </div>

  <div id="content">
    <!-- [Main content left untouched] -->
  </div>

  <div id="settings-modal">
    <!-- [Settings modal left untouched] -->
  </div>

  <script>
    const API_KEY = "0u53fn16nkajvhrbazkec1dj46ytgcpwn1zzxy7ts8qoxviwwrkhin8c3uy1";
    const correctUsername = "admin";
    const correctPassword = "gold123";

    const PURITY = {
      "24K": 1.000,
      "22K": 0.916,
      "21K": 0.875,
      "18K": 0.750,
      "14K": 0.585,
      "12K": 0.500
    };

    let lastGoldUsdPrice = null;
    let markupMultiplier = 1.82;
    let INFO_MESSAGES = [];
    let infoIndex = 0;
    let currentLanguage = 'en';

    function login() {
      const u = document.getElementById("username").value;
      const p = document.getElementById("password").value;
      const errorBox = document.getElementById("login-error");

      if (u === correctUsername && p === correctPassword) {
        document.getElementById("login-container").style.display = "none";
        document.getElementById("content").style.display = "block";
        errorBox.style.display = "none";
        updatePriceTable(); // ✅ Now this is just a call, not a definition
      } else {
        errorBox.style.display = "block";
      }
    }

    // ✅ Moved updatePriceTable OUTSIDE login()
    async function updatePriceTable() {
      try {
        const res = await fetch(`https://metals-api.com/api/latest?access_key=${API_KEY}&base=USD&symbols=XAU,JOD`);

        if (!res.ok) {
          throw new Error(`API request failed with status ${res.status}`);
        }

        const data = await res.json();

        if (!data.success) {
          throw new Error(`API error: ${data.error.info}`);
        }

        const goldUsdPerOz = data.rates.XAU;

        if (lastGoldUsdPrice !== null && Math.abs(goldUsdPerOz - lastGoldUsdPrice) < 20) {
          console.log("Gold price change < $20. Skipping update.");
          return;
        }

        lastGoldUsdPrice = goldUsdPerOz;

        const usdToJod = data.rates.JOD;
        const tbody = document.getElementById("price-table-body");
        tbody.innerHTML = "";

        Object.entries(PURITY).sort((a, b) => b[1] - a[1]).forEach(([carat, purity]) => {
          const goldPricePerOunceInJOD = (1 / goldUsdPerOz) * usdToJod;

          const adjustedOunceSell = goldPricePerOunceInJOD + 7.08 + 0.30;
          const pricePerGramSell = (adjustedOunceSell / 31.1035) * purity;

          const baseGram = (goldPricePerOunceInJOD / 31.1035) * purity;
          const pricePerGramBuy = baseGram - 2.5;

          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${carat}</td>
            <td>د.ا ${pricePerGramBuy.toFixed(2)}</td>
            <td>د.ا ${pricePerGramSell.toFixed(2)}</td>
          `;
          tbody.appendChild(row);
        });

        document.getElementById("last-update").textContent =
          "Last update: " + new Date().toLocaleTimeString();
      } catch (e) {
        console.error("Error fetching gold price:", e);
        document.getElementById("last-update").textContent =
          "Error updating prices. Please try again later.";
      }
    }

    function updateClock() {
      const now = new Date();
      const formatter = new Intl.DateTimeFormat('en-US', {
        timeZone: 'Asia/Amman',
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit',
        year: 'numeric',
        month: '2-digit',
        day: '2-digit'
      });
      const formatted = formatter.format(now);
      document.getElementById("datetime").textContent = formatted;
      const delay = 1000 - now.getMilliseconds();
      setTimeout(updateClock, delay);
    }

    function toggleLanguage() {
      currentLanguage = currentLanguage === 'en' ? 'ar' : 'en';
      applyLanguage(currentLanguage);
    }

    function applyLanguage(lang) {
      document.querySelector('.lang-button').textContent = lang === 'en' ? 'عربي' : 'English';
      document.getElementById('title').textContent = lang === 'en'
        ? 'Gold Prices in Jordan (JOD per Gram)'
        : 'أسعار الذهب في الأردن (دينار للغرام)';
      document.getElementById('carat-header').textContent = lang === 'en' ? 'Carat' : 'عيار';
      document.getElementById('buy-header').textContent = lang === 'en' ? 'Buy ' : ' الشراء';
      document.getElementById('sell-header').textContent = lang === 'en' ? 'sell ' : ' البيع';
    }

    function toggleTheme() {
      document.body.classList.toggle('dark');
      document.querySelector('.theme-button').textContent =
        document.body.classList.contains('dark') ? 'Light Mode' : 'Dark Mode';
    }

    function toggleSettings() {
      const modal = document.getElementById("settings-modal");
      modal.style.display = modal.style.display === "block" ? "none" : "block";
      document.getElementById("markup-input").value = ((markupMultiplier - 1) * 100).toFixed(2);
    }

    function applyMarkup() {
      const value = parseFloat(document.getElementById("markup-input").value);
      if (!isNaN(value) && value >= 0) {
        markupMultiplier = 1 + value / 100;
        updatePriceTable();
        toggleSettings();
      }
    }

    async function toggleFullscreen() {
      if (!document.fullscreenElement) {
        await document.documentElement.requestFullscreen();
        document.body.classList.add('fullscreen');
      }
    }

    async function exitFullscreen() {
      if (document.fullscreenElement) {
        await document.exitFullscreen();
      }
      document.body.classList.remove('fullscreen');
    }

    document.addEventListener('fullscreenchange', () => {
      if (!document.fullscreenElement) {
        document.body.classList.remove('fullscreen');
      }
    });

    function rotateInfo() {
      const infoBox = document.getElementById('info-box');
      if (INFO_MESSAGES.length > 0) {
        infoBox.textContent = INFO_MESSAGES[infoIndex];
        infoIndex = (infoIndex + 1) % INFO_MESSAGES.length;
      } else {
        infoBox.textContent = 'No messages yet. Add one below.';
      }
    }

    function addMessage() {
      const input = document.getElementById("single-message");
      const newMsg = input.value.trim();
      if (newMsg) {
        INFO_MESSAGES.push(newMsg);
        input.value = "";
        alert("Message added.");
        if (INFO_MESSAGES.length === 1) rotateInfo();
      }
    }

    applyLanguage(currentLanguage);
    rotateInfo();
    updateClock();

    setInterval(updatePriceTable, 7200000); // 2 hours
    setInterval(rotateInfo, 10000);
  </script>
</body>
</html>
